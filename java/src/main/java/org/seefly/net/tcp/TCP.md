## TCP

​	TCP协议全称就是传输控制协议

​	[详解](https://blog.csdn.net/sinat_36629696/article/details/80740678)

​	[报文头部](https://www.cnblogs.com/xcywt/p/8075623.html)

| 源端口(16 bit)                                                                  \|                                                               目标端口(16 bit) |
| ------------------------------------------------------------ |
| 序号 seq(32 bit)                                             |
| 确认号 ack(32 bit)                                           |
| 首部长度(4 bit) \| 保留位(6 bit)           \|URG\|ACK\|PSH\|RST\|SYN\|FIN\|                                      窗口大小(16 bit) |
| 校验和(16 bit)                                                                    \|                                                               紧急指针(16 bit) |
| 选项                                                         |
| 数据...                                                      |

##### 源端口、目标端口

​	表示该数据从哪个端口发出的，以及对方的端口。16 bit最大 65535，也就是计算机的最大端口号。

##### 序号、确认号

​	序号(seq): tcp将每个字节都进行编号，而序号则表示当前发送的数据中第一个字节的序号是多少。

​	确认号(ack): ACK 标志位=1时有效，表示期望接收到对方发送的下一个数据索引。

##### 首部长度

​	表示tcp头部报文有多少个4字节(15 * 4 byte = 60 byte)，也就是说头部最大60字节。

##### 6位标志位

- URG: 标识紧急指针是否有效 
- ACK: 标识确认序号是否有效 
- PSH: 用来提示接收端应用程序立刻将数据从tcp缓冲区读走 
- RST: 要求重新建立连接. 我们把含有RST标识的报文称为复位报文段 
- SYN: 请求建立连接. 我们把含有SYN标识的报文称为同步报文段 
- FIN：通知对方，本端数据已经发送完毕，准备关闭。称为结束报文段

##### 窗口大小

​	是TCP流量控制的一个手段，这里说的窗口是指接收通告窗口，它告诉对方本端的tcp接收缓冲区还能容纳多少字节的数据，这样对方就可以控制发送数据的速度。

##### 16位校验和

​	由发送端填充, 检验形式有CRC校验等. 如果接收端校验不通过, 则认为数据有问题. 此处的校验和不光包含TCP首部, 也包含TCP数据部分.

##### 16位紧急指针

​	是一个正的偏移量。它和序号字段的值相加表示最后一个紧急数据的下一字节的序号。因此这个字段是紧急指针相对当前序号的偏移量。不妨称之为紧急便宜，发送紧急数据时会用到这个。



### TCP三次握手

例如客户端主动向服务器发起建立连接的请求

1. 客户端首先发送一个同步报文段，其中包括一个同步序列号标志位SYN(Synchronize Sequence Numbers)，和一个自己的序列号seq=x。然后将自己的状态置为SYN_SEND等待服务器响应。

2. 服务端在接收到连接请求后，也会响应同步报文段。包括同步序列号标志位SYN，确认序列号有效标志位ACK，确认序列号ack=x+1，以及自己的序列号seq=y。然后将自己的状态置为SYN_RECV

3. 客户端在接收到服务端的响应后，知道服务端收到了自己的连接请求，并且序列号已经同步完毕。不再发送SYN。会发送ACK标志位，ack=y+1，seq=x+1。并将自己的状态置为启用！

   至此三次握手完成，通讯双方建立正确的连接。

#### 问题

- **为什么不是两次握手？**
  - 三次握手是确定通讯双方信道没有问题的最小次数
  - 防止失效的连接请求到达服务端导致建立错误的连接
- **为什么不是四次握手？**
  - 因为三次握手已经能够确认通讯双方的信道没有问题，四次是没有必要的。
- **ack、ACK、seq都代表什么含义？**
  - ack即tcp首部中的确认号，表示期望收到对方下一次发送字节的序列号。他总是对方上次发送的seq+1
  - seq表示自己当前发送字节的序列号
  - ACK是一个标志位，表示确认对方发送的序列号有效。



### 数据传输

#### 1、tcp如何保证在不稳定的信道上进行可靠的数据传输？

1. **滑动窗口:**数据被分割成TCP认为合适的大小交的数据段，称为段（Segment）传递给IP层。
2.  **超时重传机制**：当tcp发送一个数据段后会开启一个计时器，如果在规定时间内没有收到应答，则会重新发送。
3. **确认应答机制:** 当tcp收到另一端的数据后将会回应一个确认。
4. tcp在收到数据后会校验首部和数据部分，并和头部中的校验和进行比对，如果不对，则认为数据传输出错，丢弃该数据，这将导致对方重传数据。
5. 由于网络原因，先发送的数据可能晚于后发送的数据到达，这时候tcp会根据序列号进行排序。
6. 对于重复发送的数据，tcp会丢弃
7. tcp还提供流量控制，根据窗口大小选择合适的发送速率。

#### 2、滑动窗口

​	如果通讯双方的下一次的数据发送需要等到上一次的确认应答之后才能进行，这样的效率是很慢的。所以设想一下如果能够连续的发送多个数据段而不必排队等待上次的确认应答，这样效率会提升很多，但设计的复杂度也会随之提升。tcp的滑动窗口就是用来做这个的。

​	**窗口大小：**tcp头部中规定16 bit表示窗口大小最大65535字节，它表示无需等待确认应答就可以继续发送数据的最大值. 





### 四次挥手

​	由于TCP是全双工的，所以通讯双方都可以同时收发数据。如果一方想要断开连接就要有一种机制
来确保不会发生问题。

1. 假如客户端想要主动断开连接，那么它会向服务器发送断开连接标志**FIN=1**，并消耗一个序列号**seq=u**，同时停止主动发送数据，并将自己的状态置为**FIN_WAIT_1**状态

2. 服务端收到后会发送确认报文，**ACK=1**，同时消耗一个序号，**seq=m**，**ack=u+1** 并将自己的状态置为**CLOSE_WAIT**状态。**但服务端此时还是可以发送数据的！**
3. 客户端在收到服务端的确认报文后将自己的状态置为**FIN_WAIT_2**
4. 服务端在所有的数据都发送完毕之后会向客户端发送断开连接标志 **FIN=1，ACK=1, seq=m+k,ack=u+1**然后将自己的状态置为 **LAST_ACK**。(其中k为服务端期间发送字节的数量)
5. 客户端收到服务端的断开连接报文后，知道服务端已经将数据都发完了，此时会回应确认报文: **ACK=1,ack=m+k+1,seq=u+1**。然后将自己置为**TIME_WAIT**状态，**TIME_WAIT**状态会持续两个最大报文寿命时长。

#### 问题

- **为什么在客户端最后断开连接后还要保持TIME_WAIT状态两个最大报文寿命时长？**
  - 保证最后一个确认报文能被服务端接收。如果客户端确认报文发出后立马关闭连接的话，如果这个报文丢失，服务端会超时重传。这会造成tcp没有正确的关闭。
  - 保证不会影响下一个tcp连接，如果在关闭后不等待，该端口立马可用的话。下一个连接继续复用该端口，那么由于网络原因上一个连接的报文此时发送过来会导致是数据的不可靠。而等待两个最大报文存货时间能够确定网络上的上一个连接的所有报文都消失掉。
- **为什么是四次挥手而不是三次？**
  - 由于tcp的连接是全双工的，双方都可同时收发数据。如果一方需要断开连接需要等待对方把数据都发送完毕才行。如果像三次握手一样来断开连接，那么没法保证被断开的那一方数据能够发送完毕。



### 报文、报文段、数据报、帧

1.报文(message)
我们将位于应用层的信息分组称为报文。报文是网络中交换与传输的数据单元，也是网络传输的单元。报文包含了将要发送的完整的数据信息，其长短不需一致。报文在传输过程中会不断地封装成分组、包、帧来传输，封装的方式就是添加一些控制信息组成的首部，那些就是报文头。

2.报文段（segment）

通常是指起始点和目的地都是传输层的信息单元。

3.分组/包(packet)
分组是在网络中传输的二进制格式的单元，为了提供通信性能和可靠性，每个用户发送的数据会被分成多个更小的部分。在每个部分的前面加上一些必要的控制信息组成的首部，有时也会加上尾部，就构成了一个分组。它的起始和目的地是网络层。

4.数据报(datagram)
面向无连接的数据传输，其工作过程类似于报文交换。采用数据报方式传输时，被传输的分组称为数据报。通常是指起始点和目的地都使用无连接网络服务的的网络层的信息单元。

5.帧(frame)
帧是数据链路层的传输单元。它将上层传入的数据添加一个头部和尾部，组成了帧。它的起始点和目的点都是数据链路层。

6.数据单元（data unit）

