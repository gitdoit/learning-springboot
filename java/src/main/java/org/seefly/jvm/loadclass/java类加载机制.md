## java类加载机制

#### 1、什么是类加载

​	是指将类的class文件数据加载到内存中，将二进制数据经过一系列步骤转换成可以虚拟机处理的数据结构并存放到运行时数据区的方法区内，并在堆内存中生成一个对应的Class对象。此外这个Class对象封装了类在方法区内的数据结构，并对外暴露了访问这个数据结构的接口。

- 类加载并不总是在需要的时候才进行
- 类加载是一个将二进制数据恢复成虚拟机可以处理的数据结构的过程



------

#### 2、类的加载过程

​	**加载 ----> 验证 ----> 准备 ----> 解析 ----> 初始化**

​	注意，加载、验证、准备、初始化这四个步骤的相对开始顺序是确定的，但不表示B的开始一定在A的结束之后，同时解析阶段开始顺序则是不确定的，可能会在初始化阶段开始之后，这是为了支持Java的动态绑定。



##### 2.1、加载

1. 通过类的全限定名从某个地方获取它的二进制字节流

2. 将字节流代表的静态存储结构转化为方法区的运行时数据结构

3. 在java堆中生成一个代表这个类的Class对象



   ##### 什么时候会加载一个类？

   ​	这个问题需要和 “什么时候初或者什么条件下会始化一个已经加载的类” 区别开来，被加载的类不一定会初始化。而被初始化的类一定是被加载过的了。那么这里就只说明什么时候类会被加载而不被初始化。避免和下面的问题重复。

   - Class clazz  = Dog.class;
   - Class.forName("xxx.xxx.Dog",false,Dog.class.getClassLoader());
   - 用类加载器去加载



   ##### 加载.class文件的途径

   - 从本地系统中直接加载
   - 通过网络下载
   - 从zip jar等归档文件中加载
   - 从转悠数据库中提取
   - 将Java源文件动态编译为.class文件

##### 2.2、验证

​	验证阶段就是相当于一个安全检查，确保加载进来的Class文件不是乱七八糟的东西。它会从下面四个维度进行校验。

- **文件格式验证**

  验证加载进来的是不是class文件，即以咖啡宝贝开头的，还有版本号啥的。

- **元数据验证**

  对字节码表示的信息进行语义分析

- **字节码验证**

- **符号引用验证**

> 问题
>
> 为什么在数据都加载进来了才进行验证操作？

##### 2.3、准备

​	准备阶段是为类变量分配内存并设置类变量初始值的阶段，这些内存的分配都在方法区内。

- static关键字修饰的类变量分配内存，而成员变量是属于类实例的，需要在堆中分配
- 类变量设置初始值，如几个基本类型的int类型为0，long的为0L....
- 如果是常量即同时被static final修饰的属性，则在该阶段就进行赋值操作。

##### 2.4、解析

​	该阶段将常量池中的符号引用替换为直接引用的过程。直接引用就相当于直指目标的指针、句柄等

##### 2.5、 初始化

​	类的初始化和实例的初始化是两码事，这个阶段指的是类的初始化。这里会将类变量真正的赋值。

同时**类的静态代码块会在这一步执行**。

**初始化步骤**

- 先初始化父类，再初始化子类
- 类中有初始化语句，执行初始化语句

以下几种主动使用的方式会导致**类的初始化**：

- 创建实例对象(都创建实例了肯定先初始化类)
- 访问类成员(访问类成员肯定先给类成员准备好)
- 调用类的静态方法(静态方法可以访问类成员)
- Class.forName("XXX")
- 子类被初始化之前父类要先初始化
- 虚拟机的启动类